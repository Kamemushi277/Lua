-- TestScript 完全版
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local correctKey = "828945"
local humanoid

-- Humanoid取得
local function updateHumanoid()
    if player.Character then
        humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    end
end
player.CharacterAdded:Connect(updateHumanoid)
updateHumanoid()

-------------------------------------------------
-- メインGUI
-------------------------------------------------
local mainGui = Instance.new("ScreenGui", playerGui)
mainGui.Name = "TestScript"
mainGui.ResetOnSpawn = false
mainGui.Enabled = false

local mainFrame = Instance.new("Frame", mainGui)
mainFrame.Size = UDim2.new(0,500,0,300)
mainFrame.Position = UDim2.new(0.5,-250,0.5,-150)
mainFrame.BackgroundColor3 = Color3.fromRGB(20,20,30)
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,6)

-- Header
local header = Instance.new("Frame", mainFrame)
header.Size = UDim2.new(1,0,0,35)
header.BackgroundColor3 = Color3.fromRGB(40,40,60)
Instance.new("UICorner", header).CornerRadius = UDim.new(0,6)

local titleLabel = Instance.new("TextLabel", header)
titleLabel.Size = UDim2.new(1,-80,1,0)
titleLabel.Position = UDim2.new(0,5,0,0)
titleLabel.Text = "Test Script"
titleLabel.TextColor3 = Color3.fromRGB(255,255,255)
titleLabel.BackgroundTransparency = 1
titleLabel.TextScaled = true

local minimizeButton = Instance.new("TextButton", header)
minimizeButton.Size = UDim2.new(0,35,1,0)
minimizeButton.Position = UDim2.new(1,-80,0,0)
minimizeButton.Text = "-"
minimizeButton.TextScaled = true
minimizeButton.BackgroundColor3 = Color3.fromRGB(60,60,90)
minimizeButton.TextColor3 = Color3.fromRGB(255,255,255)

local closeButton = Instance.new("TextButton", header)
closeButton.Size = UDim2.new(0,35,1,0)
closeButton.Position = UDim2.new(1,-40,0,0)
closeButton.Text = "X"
closeButton.TextScaled = true
closeButton.BackgroundColor3 = Color3.fromRGB(150,50,50)
closeButton.TextColor3 = Color3.fromRGB(255,255,255)

-- Tabs
local tabFrame = Instance.new("Frame", mainFrame)
tabFrame.Size = UDim2.new(0,100,1,-35)
tabFrame.Position = UDim2.new(0,0,0,35)
tabFrame.BackgroundColor3 = Color3.fromRGB(30,30,40)

local basicsTab = Instance.new("TextButton", tabFrame)
basicsTab.Size = UDim2.new(1,0,0,40)
basicsTab.Text = "Basics"
basicsTab.TextScaled = true
basicsTab.BackgroundColor3 = Color3.fromRGB(80,80,140)
basicsTab.TextColor3 = Color3.fromRGB(255,255,255)

local espTab = Instance.new("TextButton", tabFrame)
espTab.Size = UDim2.new(1,0,0,40)
espTab.Position = UDim2.new(0,0,0,45)
espTab.Text = "ESP"
espTab.TextScaled = true
espTab.BackgroundColor3 = Color3.fromRGB(60,60,120)
espTab.TextColor3 = Color3.fromRGB(255,255,255)

local contentFrame = Instance.new("Frame", mainFrame)
contentFrame.Size = UDim2.new(1,-100,1,-35)
contentFrame.Position = UDim2.new(0,100,0,35)
contentFrame.BackgroundColor3 = Color3.fromRGB(20,20,40)

local basicsFrame = Instance.new("Frame", contentFrame)
basicsFrame.Size = UDim2.new(1,0,1,0)
basicsFrame.BackgroundTransparency = 1

local espFrame = Instance.new("Frame", contentFrame)
espFrame.Size = UDim2.new(1,0,1,0)
espFrame.BackgroundTransparency = 1
espFrame.Visible = false

local currentTab = "Basics"
basicsTab.MouseButton1Click:Connect(function()
    basicsFrame.Visible = true
    espFrame.Visible = false
    currentTab = "Basics"
end)
espTab.MouseButton1Click:Connect(function()
    basicsFrame.Visible = false
    espFrame.Visible = true
    currentTab = "ESP"
end)

-------------------------------------------------
-- 縮小/拡大
-------------------------------------------------
local minimized = false
local originalSize = mainFrame.Size
local function setMinimized(min)
    minimized = min
    for _,child in pairs(tabFrame:GetChildren()) do
        child.Visible = not min
    end
    basicsFrame.Visible = not min and currentTab=="Basics"
    espFrame.Visible = not min and currentTab=="ESP"

    if min then
        minimizeButton.Text = "+"
        closeButton.Visible = false
        mainFrame:TweenSize(UDim2.new(0,200,0,40), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        minimizeButton.Position = UDim2.new(1,-35,0,0)
    else
        minimizeButton.Text = "-"
        closeButton.Visible = true
        mainFrame:TweenSize(originalSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        minimizeButton.Position = UDim2.new(1,-80,0,0)
    end
end
minimizeButton.MouseButton1Click:Connect(function()
    setMinimized(not minimized)
end)

-------------------------------------------------
-- Close確認
-------------------------------------------------
closeButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
    local confirmFrame = Instance.new("Frame", mainGui)
    confirmFrame.Size = UDim2.new(0,250,0,150)
    confirmFrame.Position = UDim2.new(0.5,-125,0.5,-75)
    confirmFrame.BackgroundColor3 = Color3.fromRGB(30,30,50)
    Instance.new("UICorner", confirmFrame).CornerRadius = UDim.new(0,6)

    local closeBtn = Instance.new("TextButton", confirmFrame)
    closeBtn.Size = UDim2.new(1,-20,0,50)
    closeBtn.Position = UDim2.new(0,10,0,20)
    closeBtn.Text = "Close Window"
    closeBtn.TextScaled = true
    closeBtn.BackgroundColor3 = Color3.fromRGB(80,200,255)
    closeBtn.TextColor3 = Color3.fromRGB(255,255,255)
    closeBtn.MouseButton1Click:Connect(function()
        confirmFrame:Destroy()
        mainGui.Enabled = false
    end)

    local orLabel = Instance.new("TextLabel", confirmFrame)
    orLabel.Size = UDim2.new(1,0,0,30)
    orLabel.Position = UDim2.new(0,0,0.45,0)
    orLabel.Text = "or"
    orLabel.TextScaled = true
    orLabel.TextColor3 = Color3.fromRGB(200,200,200)
    orLabel.BackgroundTransparency = 1

    local cancelBtn = Instance.new("TextButton", confirmFrame)
    cancelBtn.Size = UDim2.new(1,-20,0,50)
    cancelBtn.Position = UDim2.new(0,10,0,80)
    cancelBtn.Text = "Cancel"
    cancelBtn.TextScaled = true
    cancelBtn.BackgroundColor3 = Color3.fromRGB(255,80,80)
    cancelBtn.TextColor3 = Color3.fromRGB(255,255,255)
    cancelBtn.MouseButton1Click:Connect(function()
        confirmFrame:Destroy()
        mainFrame.Visible = true
    end)
end)

-------------------------------------------------
-- GUIドラッグ
-------------------------------------------------
local dragging = false
local dragStart, startPos
header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
header.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-------------------------------------------------
-- パスワード画面
-------------------------------------------------
local keyGui = Instance.new("ScreenGui", playerGui)
keyGui.Name = "KeyGui"
keyGui.ResetOnSpawn = false

local keyFrame = Instance.new("Frame", keyGui)
keyFrame.Size = UDim2.new(0,300,0,150)
keyFrame.Position = UDim2.new(0.5,-150,0.5,-75)
keyFrame.BackgroundColor3 = Color3.fromRGB(20,20,30)
Instance.new("UICorner", keyFrame).CornerRadius = UDim.new(0,6)

local keyBox = Instance.new("TextBox", keyFrame)
keyBox.Size = UDim2.new(0,280,0,40)
keyBox.Position = UDim2.new(0,10,0.2,0)
keyBox.PlaceholderText = "Enter Key"
keyBox.TextColor3 = Color3.fromRGB(255,255,255)
keyBox.BackgroundColor3 = Color3.fromRGB(30,30,30)
keyBox.TextScaled = true

local keyButton = Instance.new("TextButton", keyFrame)
keyButton.Size = UDim2.new(0,280,0,35)
keyButton.Position = UDim2.new(0,10,0.55,0)
keyButton.Text = "Enter"
keyButton.TextColor3 = Color3.fromRGB(255,255,255)
keyButton.BackgroundColor3 = Color3.fromRGB(80,200,255)
keyButton.TextScaled = true

local keyError = Instance.new("TextLabel", keyFrame)
keyError.Size = UDim2.new(1,0,0,25)
keyError.Position = UDim2.new(0,0,0.85,0)
keyError.TextColor3 = Color3.fromRGB(255,0,0)
keyError.BackgroundTransparency = 1
keyError.TextScaled = true
keyError.Text = ""

local function submitKey()
    if keyBox.Text == correctKey then
        mainGui.Enabled = true
        keyGui:Destroy()
    else
        keyError.Text = "Wrong Key!"
    end
end
keyButton.MouseButton1Click:Connect(submitKey)
keyBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then submitKey() end
end)

-------------------------------------------------
-- Basics機能
-------------------------------------------------
-- NoClip / WalkSpeed / JumpPower / InfiniteJump
local noclipButton = Instance.new("TextButton", basicsFrame)
noclipButton.Size = UDim2.new(0,180,0,35)
noclipButton.Position = UDim2.new(0,20,0,20)
noclipButton.Text = "NoClip: OFF"
noclipButton.TextScaled = true
noclipButton.BackgroundColor3 = Color3.fromRGB(255,0,0)
noclipButton.TextColor3 = Color3.fromRGB(255,255,255)

local wsLabel = Instance.new("TextLabel", basicsFrame)
wsLabel.Size = UDim2.new(0,180,0,25)
wsLabel.Position = UDim2.new(0,20,0,70)
wsLabel.Text = "WalkSpeed (16-400)"
wsLabel.BackgroundTransparency = 1
wsLabel.TextScaled = true
wsLabel.TextColor3 = Color3.fromRGB(255,255,255)

local wsBox = Instance.new("TextBox", basicsFrame)
wsBox.Size = UDim2.new(0,180,0,25)
wsBox.Position = UDim2.new(0,20,0,100)
wsBox.Text = "16"
wsBox.BackgroundColor3 = Color3.fromRGB(255,255,255)
wsBox.TextScaled = true

local jpLabel = Instance.new("TextLabel", basicsFrame)
jpLabel.Size = UDim2.new(0,180,0,25)
jpLabel.Position = UDim2.new(0,20,0,135)
jpLabel.Text = "JumpPower (50-600)"
jpLabel.BackgroundTransparency = 1
jpLabel.TextScaled = true
jpLabel.TextColor3 = Color3.fromRGB(255,255,255)

local jpBox = Instance.new("TextBox", basicsFrame)
jpBox.Size = UDim2.new(0,180,0,25)
jpBox.Position = UDim2.new(0,20,0,165)
jpBox.Text = "50"
jpBox.BackgroundColor3 = Color3.fromRGB(255,255,255)
jpBox.TextScaled = true

local ijButton = Instance.new("TextButton", basicsFrame)
ijButton.Size = UDim2.new(0,180,0,35)
ijButton.Position = UDim2.new(0,20,0,200)
ijButton.Text = "Infinite Jump: OFF"
ijButton.TextScaled = true
ijButton.BackgroundColor3 = Color3.fromRGB(255,0,0)
ijButton.TextColor3 = Color3.fromRGB(255,255,255)

local noclipEnabled = false
local infiniteJumpEnabled = false
local noclipConnection

local function applyNoClip()
    if noclipConnection then noclipConnection:Disconnect() end
    noclipConnection = RunService.Stepped:Connect(function()
        if noclipEnabled and player.Character then
            for _, part in pairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end)
end

noclipButton.MouseButton1Click:Connect(function()
    noclipEnabled = not noclipEnabled
    noclipButton.Text = noclipEnabled and "NoClip: ON" or "NoClip: OFF"
    noclipButton.BackgroundColor3 = noclipEnabled and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
    applyNoClip()
end)

ijButton.MouseButton1Click:Connect(function()
    infiniteJumpEnabled = not infiniteJumpEnabled
    ijButton.Text = infiniteJumpEnabled and "Infinite Jump: ON" or "Infinite Jump: OFF"
    ijButton.BackgroundColor3 = infiniteJumpEnabled and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
end)

UserInputService.JumpRequest:Connect(function()
    if infiniteJumpEnabled and humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

wsBox.FocusLost:Connect(function(enterPressed)
    if enterPressed and humanoid then
        local value = tonumber(wsBox.Text)
        if value and value>=16 and value<=400 then
            humanoid.WalkSpeed = value
        else
            wsBox.Text = "16"
            humanoid.WalkSpeed = 16
        end
    end
end)

jpBox.FocusLost:Connect(function(enterPressed)
    if enterPressed and humanoid then
        local value = tonumber(jpBox.Text)
        if value and value>=50 and value<=600 then
            humanoid.UseJumpPower = true
            humanoid.JumpPower = value
        else
            jpBox.Text = "50"
            humanoid.UseJumpPower = true
            humanoid.JumpPower = 50
        end
    end
end)

-------------------------------------------------
-- ESP機能
-------------------------------------------------
local espList = {}
local espEnabled = {}
local espConnection

local espUIList = Instance.new("ScrollingFrame", espFrame)
espUIList.Size = UDim2.new(1,0,1,0)
espUIList.CanvasSize = UDim2.new(0,0,0,0)
espUIList.BackgroundTransparency = 1
espUIList.ScrollBarThickness = 6

local function updateESP()
    if espConnection then espConnection:Disconnect() end
    espConnection = RunService.RenderStepped:Connect(function()
        local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        for plr,_ in pairs(espEnabled) do
            if espEnabled[plr] then
                local head = plr.Character and plr.Character:FindFirstChild("Head")
                local plrHum = plr.Character and plr.Character:FindFirstChildOfClass("Humanoid")
                if head and root then
                    if not espList[plr] then
                        local bill = Instance.new("BillboardGui")
                        bill.Size = UDim2.new(0,120,0,40)
                        bill.Adornee = head
                        bill.AlwaysOnTop = true
                        bill.ExtentsOffset = Vector3.new(0, head.Size.Y/2 + 1, 0)
                        bill.Parent = workspace

                        local label = Instance.new("TextLabel", bill)
                        label.Size = UDim2.new(1,0,1,0)
                        label.BackgroundTransparency = 0.5
                        label.BackgroundColor3 = Color3.fromRGB(0,0,0)
                        label.TextColor3 = Color3.fromRGB(255,255,255)
                        label.TextScaled = true
                        label.TextStrokeTransparency = 0.5
                        espList[plr] = {bill=bill, label=label}
                    end
                    local dist = (root.Position - head.Position).Magnitude
                    local hp = plrHum and plrHum.Health or 0
                    local maxHp = plrHum and plrHum.MaxHealth or 100
                    espList[plr].label.Text = string.format("%s %.1fm\nHP: %.0f/%.0f", plr.Name, dist, hp, maxHp)
                end
            else
                if espList[plr] then
                    espList[plr].bill:Destroy()
                    espList[plr] = nil
                end
            end
        end
    end)
end

local function addPlayerToESP(plr)
    if plr == player then return end
    if espEnabled[plr] ~= nil then return end
    espEnabled[plr] = false

    local plrFrame = Instance.new("Frame", espUIList)
    plrFrame.Size = UDim2.new(1,-20,0,30)
    plrFrame.Position = UDim2.new(0,10,0,espUIList.CanvasSize.Y.Offset)
    plrFrame.BackgroundTransparency = 0.5
    plrFrame.BackgroundColor3 = Color3.fromRGB(50,50,50)

    local nameLabel = Instance.new("TextLabel", plrFrame)
    nameLabel.Size = UDim2.new(0.7,0,1,0)
    nameLabel.Position = UDim2.new(0,0,0,0)
    nameLabel.Text = plr.Name
    nameLabel.TextScaled = true
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(255,255,255)

    local toggleButton = Instance.new("TextButton", plrFrame)
    toggleButton.Size = UDim2.new(0.3,0,1,0)
    toggleButton.Position = UDim2.new(0.7,0,0,0)
    toggleButton.Text = "OFF"
    toggleButton.TextScaled = true
    toggleButton.BackgroundColor3 = Color3.fromRGB(255,0,0)
    toggleButton.MouseButton1Click:Connect(function()
        espEnabled[plr] = not espEnabled[plr]
        toggleButton.Text = espEnabled[plr] and "ON" or "OFF"
        toggleButton.BackgroundColor3 = espEnabled[plr] and Color3.fromRGB(0,255,0) or Color3.fromRGB(255,0,0)
        updateESP()
    end)

    local currentY = espUIList.CanvasSize.Y.Offset
    espUIList.CanvasSize = UDim2.new(0,0,0,currentY + 35)
end

for _,plr in pairs(Players:GetPlayers()) do
    addPlayerToESP(plr)
end
Players.PlayerAdded:Connect(addPlayerToESP)
Players.PlayerRemoving:Connect(function(plr)
    if espList[plr] then
        espList[plr].bill:Destroy()
        espList[plr] = nil
    end
    if espEnabled[plr] ~= nil then espEnabled[plr] = nil end
    for _,frame in pairs(espUIList:GetChildren()) do
        local label = frame:FindFirstChildWhichIsA("TextLabel")
        if label and label.Text == plr.Name then
            frame:Destroy()
        end
    end
end)

updateESP()