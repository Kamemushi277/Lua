local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local humanoid

local settings = {
    NoClip = false,
    WalkSpeed = 16,
    JumpPower = 50,
    InfiniteJump = false
}

local function updateHumanoid()
    if player.Character then
        humanoid = player.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = settings.WalkSpeed
            humanoid.UseJumpPower = true
            humanoid.JumpPower = settings.JumpPower
            if settings.NoClip then
                applyNoClip()
            end
        end
    end
end
player.CharacterAdded:Connect(updateHumanoid)
updateHumanoid()

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local keyGui = Instance.new("ScreenGui", playerGui)
keyGui.Name = "KeyGui"
keyGui.ResetOnSpawn = false

local keyFrame = Instance.new("Frame", keyGui)
keyFrame.Size = UDim2.new(0, 300, 0, 150)
keyFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
keyFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
keyFrame.BackgroundTransparency = 0.3
Instance.new("UICorner", keyFrame).CornerRadius = UDim.new(0, 6)

local keyBox = Instance.new("TextBox", keyFrame)
keyBox.Size = UDim2.new(0, 280, 0, 40)
keyBox.Position = UDim2.new(0, 10, 0.2, 0)
keyBox.PlaceholderText = "Enter Key"
keyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
keyBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
keyBox.BackgroundTransparency = 0.3
keyBox.TextScaled = true
keyBox.TextTransparency = 0.2

local keyButton = Instance.new("TextButton", keyFrame)
keyButton.Size = UDim2.new(0, 280, 0, 35)
keyButton.Position = UDim2.new(0, 10, 0.55, 0)
keyButton.Text = "Enter"
keyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
keyButton.BackgroundColor3 = Color3.fromRGB(80, 200, 255)
keyButton.BackgroundTransparency = 0.3
keyButton.TextScaled = true
keyButton.TextTransparency = 0.2

local keyError = Instance.new("TextLabel", keyFrame)
keyError.Size = UDim2.new(1, 0, 0, 25)
keyError.Position = UDim2.new(0, 0, 0.85, 0)
keyError.TextColor3 = Color3.fromRGB(255, 0, 0)
keyError.BackgroundTransparency = 1
keyError.TextScaled = true
keyError.Text = ""
keyError.TextTransparency = 0.2

local correctKey = "828945"
local function submitKey()
    if keyBox.Text == correctKey then
        keyGui:Destroy()
        print("キー認証成功")
        Rayfield:Notify({
            Title = "キー認証",
            Content = "認証成功！GUIを表示します。",
            Duration = 3
        })
        initializeMainGui()
    else
        keyError.Text = "Wrong Key!"
        Rayfield:Notify({
            Title = "エラー",
            Content = "間違ったキーを入力しました",
            Duration = 3
        })
    end
end
keyButton.MouseButton1Click:Connect(submitKey)
keyBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then submitKey() end
end)

function initializeMainGui()
    local Window = Rayfield:CreateWindow({
        Name = "Test Script",
        LoadingTitle = "Test Script",
        LoadingSubtitle = "by [Your Name]",
        ConfigurationSaving = {
            Enabled = true,
            FolderName = "TestScriptConfig",
            FileName = "Settings"
        },
        KeySystem = false
    })

    local BasicsTab = Window:CreateTab("Basics", nil)

    local noclipEnabled = false
    local noclipConnection
    local noclipParts = {}
    local function applyNoClip()
        if noclipConnection then noclipConnection:Disconnect() end
        if noclipEnabled and player.Character then
            noclipParts = {}
            for _, part in pairs(player.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                    table.insert(noclipParts, part)
                end
            end
            noclipConnection = RunService.Stepped:Connect(function()
                if noclipEnabled and player.Character then
                    for _, part in pairs(noclipParts) do
                        if part.Parent then
                            part.CanCollide = false
                        end
                    end
                else
                    noclipConnection:Disconnect()
                end
            end)
        end
    end

    BasicsTab:CreateToggle({
        Name = "NoClip",
        CurrentValue = settings.NoClip,
        Callback = function(Value)
            noclipEnabled = Value
            settings.NoClip = Value
            applyNoClip()
            Rayfield:Notify({
                Title = "NoClip",
                Content = "NoClipを" .. (Value and "有効" or "無効") .. "にしました",
                Duration = 3
            })
        end
    })

    BasicsTab:CreateInput({
        Name = "WalkSpeed (16-400)",
        PlaceholderText = "16",
        RemoveTextAfterFocusLost = false,
        Callback = function(Text)
            local value = tonumber(Text)
            if value and value >= 16 and value <= 400 and humanoid then
                humanoid.WalkSpeed = value
                settings.WalkSpeed = value
                Rayfield:Notify({
                    Title = "WalkSpeed",
                    Content = "WalkSpeedを" .. value .. "に設定しました",
                    Duration = 3
                })
            else
                Rayfield:Notify({
                    Title = "エラー",
                    Content = "16～400の範囲で入力してください",
                    Duration = 3
                })
            end
        end
    })

    BasicsTab:CreateInput({
        Name = "JumpPower (50-600)",
        PlaceholderText = "50",
        RemoveTextAfterFocusLost = false,
        Callback = function(Text)
            local value = tonumber(Text)
            if value and value >= 50 and value <= 600 and humanoid then
                humanoid.UseJumpPower = true
                humanoid.JumpPower = value
                settings.JumpPower = value
                Rayfield:Notify({
                    Title = "JumpPower",
                    Content = "JumpPowerを" .. value .. "に設定しました",
                    Duration = 3
                })
            else
                Rayfield:Notify({
                    Title = "エラー",
                    Content = "50～600の範囲で入力してください",
                    Duration = 3
                })
            end
        end
    })

    local infiniteJumpEnabled = false
    BasicsTab:CreateToggle({
        Name = "Infinite Jump",
        CurrentValue = settings.InfiniteJump,
        Callback = function(Value)
            infiniteJumpEnabled = Value
            settings.InfiniteJump = Value
            Rayfield:Notify({
                Title = "Infinite Jump",
                Content = "Infinite Jumpを" .. (Value and "有効" or "無効") .. "にしました",
                Duration = 3
            })
        end
    })

    UserInputService.JumpRequest:Connect(function()
        if infiniteJumpEnabled and humanoid then
            humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end)

    local ESPTab = Window:CreateTab("ESP", nil)
    local espList = {}
    local espEnabled = {}
    local espConnection

    local function updateESP()
        if espConnection then espConnection:Disconnect() end
        espConnection = RunService.Heartbeat:Connect(function()
            task.wait(0.1)
            local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if not root then return end
            for plr, _ in pairs(espEnabled) do
                if espEnabled[plr] then
                    local head = plr.Character and plr.Character:FindFirstChild("Head")
                    local plrHum = plr.Character and plr.Character:FindFirstChildOfClass("Humanoid")
                    if head then
                        if not espList[plr] then
                            local bill = Instance.new("BillboardGui")
                            bill.Size = UDim2.new(0, 120, 0, 40)
                            bill.Adornee = head
                            bill.AlwaysOnTop = true
                            bill.ExtentsOffset = Vector3.new(0, head.Size.Y / 2 + 1, 0)
                            bill.Parent = workspace
                            local label = Instance.new("TextLabel", bill)
                            label.Size = UDim2.new(1, 0, 1, 0)
                            label.BackgroundTransparency = 0.5
                            label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
                            label.TextColor3 = Color3.fromRGB(255, 255, 255)
                            label.TextScaled = true
                            label.TextStrokeTransparency = 0.5
                            espList[plr] = { bill = bill, label = label }
                        end
                        local dist = (root.Position - head.Position).Magnitude
                        local hp = plrHum and plrHum.Health or 0
                        local maxHp = plrHum and plrHum.MaxHealth or 100
                        espList[plr].label.Text = string.format("%s %.1fm\nHP: %.0f/%.0f", plr.Name, dist, hp, maxHp)
                    end
                else
                    if espList[plr] then
                        espList[plr].bill:Destroy()
                        espList[plr] = nil
                    end
                end
            end
        end)
    end

    local function addPlayerToESP(plr)
        if plr == player then return end
        if espEnabled[plr] ~= nil then return end
        espEnabled[plr] = false
        ESPTab:CreateToggle({
            Name = plr.Name,
            CurrentValue = false,
            Callback = function(Value)
                espEnabled[plr] = Value
                updateESP()
                Rayfield:Notify({
                    Title = "ESP",
                    Content = plr.Name .. " のESPを" .. (Value and "有効" or "無効") .. "にしました",
                    Duration = 3
                })
            end
        })
    end

    for _, plr in pairs(Players:GetPlayers()) do
        addPlayerToESP(plr)
    end
    Players.PlayerAdded:Connect(addPlayerToESP)
    Players.PlayerRemoving:Connect(function(plr)
        if espList[plr] then
            espList[plr].bill:Destroy()
            espList[plr] = nil
        end
        if espEnabled[plr] ~= nil then espEnabled[plr] = nil end
    end)

    updateESP()

    local TeleportTab = Window:CreateTab("Teleport", nil)

    local function updateTeleportDropdown(dropdown)
        local playerNames = {}
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= player then
                table.insert(playerNames, plr.Name)
                print("プレイヤー追加: " .. plr.Name)
            end
        end
        dropdown:Refresh(playerNames, true)
        print("ドロップダウン更新: " .. #playerNames .. " プレイヤー")
    end

    local teleportDropdown = TeleportTab:CreateDropdown({
        Name = "Teleport to Player",
        Options = {},
        CurrentOption = {"Select Player"},
        MultipleOptions = false,
        Callback = function(Option)
            print("ドロップダウン選択: " .. tostring(Option))
            if type(Option) == "table" then
                Option = Option[1]
                print("テーブルから抽出されたオプション: " .. tostring(Option))
            end
            if Option == "Select Player" or not Option then
                Rayfield:Notify({
                    Title = "エラー",
                    Content = "有効なプレイヤーを選択してください",
                    Duration = 3
                })
                return
            end
            local targetPlayer = Players:FindFirstChild(Option)
            if not targetPlayer then
                Rayfield:Notify({
                    Title = "エラー",
                    Content = "プレイヤーが見つかりません: " .. tostring(Option),
                    Duration = 3
                })
                return
            end
            if not targetPlayer.Character then
                Rayfield:Notify({
                    Title = "エラー",
                    Content = targetPlayer.Name .. " のキャラクターがロードされていません",
                    Duration = 3
                })
                return
            end
            if not player.Character then
                Rayfield:Notify({
                    Title = "エラー",
                    Content = "あなたのキャラクターがロードされていません",
                    Duration = 3
                })
                return
            end
            local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
            local myRoot = player.Character:FindFirstChild("HumanoidRootPart")
            if not targetRoot or not myRoot then
                Rayfield:Notify({
                    Title = "エラー",
                    Content = "HumanoidRootPartが見つかりません",
                    Duration = 3
                })
                return
            end
            myRoot.CFrame = CFrame.new(targetRoot.Position + Vector3.new(0, 5, 0))
            Rayfield:Notify({
                Title = "成功",
                Content = targetPlayer.Name .. " にテレポートしました",
                Duration = 3
            })
        end
    })

    Players.PlayerAdded:Connect(function(plr)
        if plr ~= player then
            updateTeleportDropdown(teleportDropdown)
        end
    end)

    Players.PlayerRemoving:Connect(function(plr)
        if plr ~= player then
            updateTeleportDropdown(teleportDropdown)
        end
    end)

    updateTeleportDropdown(teleportDropdown)

    noclipEnabled = settings.NoClip
    if noclipEnabled then applyNoClip() end
    infiniteJumpEnabled = settings.InfiniteJump
end